<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NetSentinel Live Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --bg:#f7f9fc;--card:#fff;--border:#e5e7eb;
  --blue:#3b82f6;--red:#ef4444;--orange:#f59e0b;--green:#22c55e;--text:#111;
  --muted:#6b7280;--shadow:rgba(0,0,0,0.08);
  transition:background 0.3s,color 0.3s;
}
body.dark{
  --bg:#0f172a;--card:#1e293b;--border:#334155;
  --blue:#60a5fa;--red:#f87171;--orange:#fbbf24;--green:#4ade80;--text:#e2e8f0;
  --shadow:rgba(255,255,255,0.06);
}
body{font-family:"Segoe UI",sans-serif;background:var(--bg);margin:0;color:var(--text);transition:all .3s}
header{background:var(--card);padding:20px;text-align:center;box-shadow:0 2px 6px var(--shadow);display:flex;justify-content:space-between;align-items:center}
h1{margin:0;color:var(--blue);display:flex;align-items:center;gap:8px}
.shield{font-size:28px}
#themeToggle{background:none;border:none;cursor:pointer;font-size:22px;color:var(--text);transition:transform .2s}
#themeToggle:hover{transform:scale(1.2)}

.cards{display:flex;justify-content:space-around;flex-wrap:wrap;margin:20px;gap:15px}
.card{flex:1;min-width:200px;padding:20px;border-radius:12px;text-align:center;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.blue{background:var(--blue)}.red{background:var(--red)}.orange{background:var(--orange)}.green{background:var(--green)}
.card h2{margin:0;font-size:16px}.card p{margin:8px 0 0;font-size:32px;font-weight:bold}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin:20px}
.panel{background:var(--card);border-radius:10px;box-shadow:0 2px 6px var(--shadow);padding:14px}
.title{font-weight:bold;margin:4px 0 8px}
.actions{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
button{background:var(--blue);border:none;color:#fff;border-radius:6px;padding:8px 12px;cursor:pointer;transition:all 0.2s}
button:hover{opacity:0.9;transform:scale(1.02);}
button.red{background:var(--red)}button.gray{background:#64748b}
table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--border)}thead{background:#f1f5f9}
body.dark thead{background:#1e293b}
.chat{background:var(--card);margin:20px;border-radius:10px;padding:16px;box-shadow:0 2px 6px var(--shadow)}
.chat h3{color:var(--blue);margin-top:0}
input[type=text]{width:80%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--text)}
#chatOutput{margin-top:10px;white-space:pre-wrap;font-family:monospace;color:var(--text);
  border:1px dashed var(--border);border-radius:6px;padding:10px;min-height:70px;background:var(--card)}

/* === Risk bar === */
.riskbar{height:8px;border-radius:4px;width:60px;background:#d1d5db;margin:auto}
.risk-low{background:var(--green)}
.risk-mid{background:var(--orange)}
.risk-high{background:var(--red)}

/* === Modal with animation === */
#detailsModal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;
  background:rgba(0,0,0,0.4);backdrop-filter:blur(4px);animation:fadeIn 0.3s ease forwards;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal-content{background:var(--card);margin:10% auto;padding:20px;border-radius:12px;
  width:80%;max-width:650px;box-shadow:0 4px 15px var(--shadow);
  transform:translateY(-40px);animation:slideDown 0.3s ease forwards;}
@keyframes slideDown{to{transform:translateY(0);}}
.modal-header{display:flex;justify-content:space-between;align-items:center;}
.modal-header h3{margin:0;color:var(--blue);}
.close{color:var(--text);font-size:24px;font-weight:bold;cursor:pointer;transition:color 0.2s;}
.close:hover{color:var(--red);}
pre{background:#f9fafb;padding:10px;border-radius:8px;overflow:auto;font-size:13px;border:1px solid var(--border);}
body.dark pre{background:#1e293b;}
</style>
</head>
<body>
<header>
  <h1><span class="shield">üõ°Ô∏è</span> NetSentinel Dashboard</h1>
  <button id="themeToggle" title="Toggle Theme">üåô</button>
</header>

<section class="cards">
  <div class="card blue"><h2>Total Queries</h2><p id="kpiTotal">--</p></div>
  <div class="card red"><h2>Blocked</h2><p id="kpiBlocked">--</p></div>
  <div class="card orange"><h2>Blocked %</h2><p id="kpiPct">--%</p></div>
  <div class="card green"><h2>Blocklist Count</h2><p id="kpiBlockCount">--</p></div>
</section>

<section class="grid">
  <div class="panel">
    <div class="title" style="color:#dc2626">Blocked Domains</div>
    <table><thead><tr><th>Domain</th><th>Client</th><th>Time</th><th>Tier-2</th><th>Actions</th></tr></thead><tbody id="blockedBody"></tbody></table>
    <div class="actions">
      <button class="gray" onclick="pagePrev('blocked')">‚óÄ Prev</button>
      <span id="blockedPage">Page 1</span>
      <button class="gray" onclick="pageNext('blocked')">Next ‚ñ∂</button>
      <!-- Clear ONLY blocked logs -->
      <button class="red" onclick="clearLogs('blocked')">üóë Clear</button>
    </div>
  </div>

  <div class="panel">
    <div class="title" style="color:#16a34a">Allowed Domains</div>
    <table><thead><tr><th>Domain</th><th>Client</th><th>Time</th><th>Tier-2</th><th>Actions</th></tr></thead><tbody id="allowedBody"></tbody></table>
    <div class="actions">
      <button class="gray" onclick="pagePrev('allowed')">‚óÄ Prev</button>
      <span id="allowedPage">Page 1</span>
      <button class="gray" onclick="pageNext('allowed')">Next ‚ñ∂</button>
      <!-- Clear ONLY allowed logs -->
      <button class="red" onclick="clearLogs('allowed')">üóë Clear</button>
    </div>
  </div>
</section>

<section class="chat">
  <h3>ü§ñ Ask Why a Domain Was Blocked</h3>
  <input id="askInput" type="text" placeholder="Enter Query ID (QX-...) or Domain">
  <button onclick="askReason()">Ask</button>
  <div id="chatOutput">Awaiting input...</div>
</section>

<!-- === Modal for Tier-2 Details === -->
<div id="detailsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modalTitle">Tier-2 Intelligence</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const PAGE_SIZE=5;
let logs=[],lists={allowlist:[],blocklist:[]},pages={blocked:1,allowed:1};

/* === THEME TOGGLE === */
const toggleBtn=document.getElementById('themeToggle');
function setTheme(dark){
  document.body.classList.toggle('dark',dark);
  toggleBtn.textContent=dark?'‚òÄÔ∏è':'üåô';
  localStorage.setItem('theme',dark?'dark':'light');
}
toggleBtn.onclick=()=>setTheme(!document.body.classList.contains('dark'));
setTheme(localStorage.getItem('theme')==='dark');

/* === HELPERS === */
function dedupe(rows){const seen=new Set(),out=[];for(const r of rows){if(!seen.has(r.domain)){seen.add(r.domain);out.push(r);}}return out;}
function paginate(arr,page){return arr.slice((page-1)*PAGE_SIZE,(page)*PAGE_SIZE);}
function setPageLabel(k,total){document.getElementById(k+'Page').textContent=`Page ${pages[k]} of ${Math.ceil(total/PAGE_SIZE)||1}`;}
function riskClass(score){if(score>0.7)return' risk-high';if(score>0.4)return' risk-mid';return' risk-low';}

/* === DATA LOAD === */
async function loadAll(){
  const [lgs,lst]=await Promise.all([fetch('/api/logs').then(r=>r.json()),fetch('/api/lists').then(r=>r.json())]);
  logs=lgs||[];lists=lst||{};
  const total=logs.length,blocked=logs.filter(x=>x.verdict==='BLOCK'||x.verdict==='MALICIOUS').length;
  document.getElementById('kpiTotal').textContent=total||0;
  document.getElementById('kpiBlocked').textContent=blocked||0;
  document.getElementById('kpiPct').textContent=total?((blocked/total*100).toFixed(1)+'%'):'--%';
  document.getElementById('kpiBlockCount').textContent=lists.block_count||lists.blocklist?.length||0;

  const sorted=[...logs].sort((a,b)=>(b.timestamp||'').localeCompare(a.timestamp||''));
  const blockRows=dedupe(sorted.filter(x=>x.verdict==='BLOCK'||x.verdict==='MALICIOUS'));
  const allowRows=dedupe(sorted.filter(x=>x.verdict==='ALLOW'||x.verdict==='LEGIT'));
  renderTable('blocked',blockRows,lists.blocklist);
  renderTable('allowed',allowRows,lists.allowlist);
}

function renderTable(kind,rows,listFile){
  const body=document.getElementById(kind+'Body');body.innerHTML='';
  const pageRows=paginate(rows,pages[kind]);
  for(const r of pageRows){
    const score=r.tier2_score!==undefined?Number(r.tier2_score):null;
    const bar=score!==null?`<div class="riskbar${riskClass(score)}" title="${score.toFixed(2)}"></div>`:'-';
    body.innerHTML+=`
    <tr>
      <td>${r.domain}</td>
      <td>${r.client_ip||'-'}</td>
      <td>${r.timestamp||'-'}</td>
      <td style="text-align:center">${bar}</td>
      <td>
        <button onclick="showDetails('${r.query_id}')">üîç</button>
        <!-- row delete = remove log entry -->
        <button class="red" onclick="deleteLog('${r.query_id}')">üóë</button>
      </td>
    </tr>`;
  }
  setPageLabel(kind,rows.length);
}

function pageNext(k){pages[k]++;loadAll();}
function pagePrev(k){if(pages[k]>1){pages[k]--;loadAll();}}

/* (keep list helpers if you still use them elsewhere) */
async function removeFromList(type,domain){if(!confirm('Remove '+domain+' from '+type+'list?'))return;
  await fetch('/api/lists/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type,domain})});loadAll();}
async function clearList(type){if(!confirm('Clear '+type+' list?'))return;
  await fetch('/api/lists/clear',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({type})});loadAll();}

/* === NEW: log delete / clear === */
async function deleteLog(qid){
  if(!confirm('Delete this log entry?')) return;
  try{
    const r = await fetch('/api/logs/delete', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ query_id: qid })
    });
    const ct = r.headers.get('content-type')||'';
    const data = ct.includes('application/json') ? await r.json() : {error: await r.text()};
    if(!r.ok || data.error){ alert('Delete failed: ' + (data.error || r.status)); return; }
    if(!data.ok || data.deleted === 0){ alert('Nothing deleted (query_id not found).'); return; }
    loadAll();
  }catch(e){ alert('Delete failed: ' + e); }
}

async function clearLogs(scope){  // 'blocked' or 'allowed'
  if(!confirm('Clear '+scope+' logs?')) return;
  try{
    const r = await fetch('/api/logs/clear', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ scope })
    });
    const ct = r.headers.get('content-type')||'';
    const data = ct.includes('application/json') ? await r.json() : {error: await r.text()};
    if(!r.ok || data.error){ alert('Clear failed: ' + (data.error || r.status)); return; }
    loadAll();
  }catch(e){ alert('Clear failed: ' + e); }
}

/* === Ask Why === */
async function askReason(){
  const q=document.getElementById('askInput').value.trim();
  const out=document.getElementById('chatOutput');
  if(!q){alert('Enter a query ID or domain');return;}
  let row=logs.find(x=>x.query_id===q||x.domain===q);
  out.textContent='‚è≥ Fetching explanation...';
  try{
    const r=await fetch(`/api/report/${encodeURIComponent(q)}`);
    const data=await r.json();
    if(!r.ok||!data||(!data.narrative&&!data.error)){out.textContent='‚ö†Ô∏è Error fetching report.';return;}
    if(data.error){out.textContent='‚ö†Ô∏è '+data.error;return;}
    let header='';
    if(row){header=`Query: ${row.query_id}\nDomain: ${row.domain}\nClient: ${row.client_ip}\nVerdict: ${row.verdict}\nTime: ${row.timestamp}\n\n`;}
    out.textContent=header+(data.narrative||'');
  }catch(e){out.textContent='‚ö†Ô∏è Error fetching report.';}
}

/* === MODAL (Tier-2 via proxy /api/tier2) === */
async function showDetails(qid){
  const modal=document.getElementById('detailsModal');
  const title=document.getElementById('modalTitle');
  const body=document.getElementById('modalBody');

  title.textContent="Tier-2 Intelligence";
  body.innerHTML="<p>Computing Tier-2‚Ä¶ ‚è≥</p>";
  modal.style.display='block';

  try{
    const r=await fetch(`/api/tier2/${encodeURIComponent(qid)}`);
    const ct=r.headers.get('content-type')||'';
    const data=ct.includes('application/json')?await r.json():{error:await r.text()};
    if(!r.ok||data.error){ body.innerHTML=`<p>‚ö†Ô∏è ${data.error||'Tier-2 lookup failed.'}</p>`; return; }

    const intel=data.tier2_intel||{};
    const enrich=data.tier2_enrichment||{};
    const score=Number(data.tier2_score||0).toFixed(2);

    title.textContent=`Tier-2 Intelligence for ${data.domain}`;
    body.innerHTML=`
      <p><b>Tier-2 Score:</b> ${score}</p>
      <h4>üîé Threat Intel (VirusTotal)</h4>
      <pre>${Object.keys(intel).length?JSON.stringify(intel,null,2):'No data'}</pre>
      <h4>üåê URL Enrichment</h4>
      <pre>${Object.keys(enrich).length?JSON.stringify(enrich,null,2):'No data'}</pre>`;
  }catch(e){
    body.innerHTML=`<p>‚ö†Ô∏è ${e}</p>`;
  }
}

function closeModal(){document.getElementById('detailsModal').style.display='none';}
window.onclick=e=>{if(e.target==document.getElementById('detailsModal'))closeModal();}

loadAll();setInterval(loadAll,5000);
</script>
</body>
</html>
